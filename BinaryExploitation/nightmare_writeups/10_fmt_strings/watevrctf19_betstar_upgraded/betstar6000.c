#include <time.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

/*
*   Compile with: gcc betstar6000.c -z norelro -s -o betstar6000
*   
*   -s flag tells gcc to strip the symbol table
*   Should be compiled in a 32-bit docker container
*/

#define MAX_NAME_LEN 48

/* This is needed for things to work properly remotely */
void init_buffering()
{
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);	
}

int modify_name(char* player_storage, int num_existing_players)
{
    char user_in_num[4];
    int player_index;
    int name_len;

    printf("Change the player at which index? ");
    fgets(user_in_num, 4, stdin);
    player_index = atoi(user_in_num);
    if (player_index >= num_existing_players || player_index < 0)
    {
        puts("invalid index!");
        return 0;
    }
    printf("Enter new name: ");
    fgets(player_storage + (player_index * MAX_NAME_LEN), MAX_NAME_LEN, stdin);
    name_len = strnlen((player_storage + (player_index * MAX_NAME_LEN)), MAX_NAME_LEN);
    if (*(player_storage + (player_index * MAX_NAME_LEN) + name_len - 1) == '\n')
    {
        *(player_storage + (player_index * MAX_NAME_LEN) + name_len - 1) = '\0';
    }
    puts("name has been changed");

    return 0;
}

int add_latecomer(char* player_storage, int num_existing_players)
{
    int name_len;
    char* tmp_ptr = NULL;

    tmp_ptr = realloc(player_storage, (num_existing_players * MAX_NAME_LEN * sizeof(char)) + MAX_NAME_LEN);
    if (tmp_ptr == NULL)
    {
        printf("realloc error\n");
        return 0;
    }
    player_storage = tmp_ptr;
    tmp_ptr = NULL;

    puts("Adding a latecomer:");
    printf("Enter their name: ");
    fgets(player_storage + (num_existing_players * MAX_NAME_LEN), MAX_NAME_LEN, stdin);
    name_len = strnlen((player_storage + (num_existing_players * MAX_NAME_LEN)), MAX_NAME_LEN);
    if (*(player_storage + (num_existing_players * MAX_NAME_LEN) + name_len - 1) == '\n')
    {
        *(player_storage + (num_existing_players * MAX_NAME_LEN) + name_len - 1) = '\0';
    }
    printf("%s added\n", (player_storage + (num_existing_players * MAX_NAME_LEN)));

    return 0;
}

int play_round(char* player_storage, int num_existing_players)
{
    char user_in_num[4];
    int num_players;
    int random_number;
    int current_guess = 0;
    int current_winner = 0;
    int best_guess_difference = 9999;

    char player[MAX_NAME_LEN];

    printf("Amount of players playing this round: ");
    fgets(user_in_num, 4, stdin);

    num_players = atoi(user_in_num);

    if (num_players > num_existing_players)
    {
        printf("We don't have %d players!\n", num_players);
        return 1;
    }

    puts("Each player makes a bet between 0 -> 100, the one who lands closest wins the round!");
    random_number = rand();
    random_number = random_number % 100;

    for (int i = 0; i < num_players; i++)
    {
        strncpy(player, (player_storage + (i * MAX_NAME_LEN)), MAX_NAME_LEN);
        printf("%s's bet: ", player);
        fgets(user_in_num, 5, stdin);

        current_guess = atoi(user_in_num);
        if (abs(random_number - current_guess) < best_guess_difference)
        {
            best_guess_difference = abs(random_number - current_guess);
            current_winner = i;
        }
    }
    printf("And the winner is: ");
    printf(player_storage + (current_winner * MAX_NAME_LEN));
    printf("\n");

    return 0;
}

int get_menu()
{
    int ret_val;
    char user_in_buf[20];

    puts("Select a menu option:");
    printf("1: Play a round\n2: Add a latecomer\n3: Edit Player Name\n4: Exit\n");
    printf(">>");

    fgets(user_in_buf, 20, stdin);
    ret_val = atoi(user_in_buf);

    return ret_val;
}

int main()
{
    init_buffering();

    int menu_option;
    int num_players;
    int name_len;
    char num_players_in_buff[4];

    char* name_storage = NULL;

    char c;

    srand(time(0));

    puts("Welcome to the ultimate betting service.");
    puts("Enter the amount of players: ");

    fgets(num_players_in_buff, 3, stdin);
    num_players = atoi(num_players_in_buff);

    name_storage = calloc(num_players, sizeof(char) * MAX_NAME_LEN);
    if (name_storage == NULL)
    {
        printf("calloc error\n");
        exit(0);
    }

    for (int i = 0; i < num_players; i++)
    {
        printf("Enter a name: ");
        fgets((name_storage + (i * MAX_NAME_LEN)), MAX_NAME_LEN, stdin);
        name_len = strnlen((name_storage + (i * MAX_NAME_LEN)), MAX_NAME_LEN);
        if (*(name_storage + (i * MAX_NAME_LEN) + name_len - 1) == '\n')
        {
            *(name_storage + (i * MAX_NAME_LEN) + name_len - 1) = '\0';
        }
    }

    puts("Alright, now lets start!");

    while(1)
    {
        menu_option = get_menu();
        if (menu_option == 1) // play a round
        {
            play_round(name_storage, num_players);
        }
        else if (menu_option == 2)
        {
            add_latecomer(name_storage, num_players);
            num_players += 1;
        }
        else if (menu_option == 3)
        {
            modify_name(name_storage, num_players);
        }
        else if (menu_option == 4) // Exit the game
        {
            break;
        }
        else{
            puts("I think you mistyped...");
        }
    }

    return 0;
}