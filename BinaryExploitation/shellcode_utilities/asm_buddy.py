# Utility to generate opcodes from asm on the command line ( or vise - versa)

# Most basic usage for assembling:
#   python3 asm_buddy.py -a x64 -f a -i "nop"

# Most basic usage for dessembling
#   python3 asm_buddy.py -a x64 -f d -i "\x90"

# if architecture is not specified with -a, x64 is assumed

import capstone
import keystone
import argparse

def disassemble(args):
    if args.arch == "x86":
        md = capstone.Cs(capstone.CS_ARCH_X86, capstone.CS_MODE_32)
    if args.arch == "x64":
        md = capstone.Cs(capstone.CS_ARCH_X86, capstone.CS_MODE_64)
    if args.arch == "arm":
        md = capstone.Cs(capstone.CS_ARCH_ARM, capstone.CS_MODE_ARM)
    
    md.detail = True

    CODE = args.input
    CODE = [CODE[x:x+2] for x in range(0, len(CODE), 2)]
    CODE = b''.join([int(x, 16).to_bytes(1, 'little') for x in CODE])

    for op in md.disasm(CODE, 0):
        if args.verbose == True:
            if hasattr(op, "_detail"):
                print("%-10x | %-15s | %-15s | %2d | %-10s | %-15s | %-12s" % (op.address, op.prefix, op.opcode, len(op.operands), op.mnemonic, op.op_str,  "".join('{:02x}'.format(x) for x in op.bytes)))
        else:
            print("%-10s%s" % (op.mnemonic, op.op_str))

def assemble(args):

    if args.arch == "x86":
        ks = keystone.Ks(keystone.KS_ARCH_X86, keystone.KS_MODE_32)
    if args.arch == "x64":
        ks = keystone.Ks(keystone.KS_ARCH_X86, keystone.KS_MODE_64)
    if args.arch == "arm":
        ks = keystone.Ks(keystone.KS_ARCH_ARM, keystone.KS_MODE_ARM)

    CODE = args.input

    ASM = ks.asm(CODE)
    ASM = ["\\x%.2X" % x for x in ASM[0]]

    print("".join(ASM))

def main():
    parser = argparse.ArgumentParser(description="Generate ASM or disasemble bytes. ASM should be semi-colon separated (\";\").")
    parser.add_argument("-a", "--arch", help="Architecture choice.", default="x64", choices=["x86", "x64", "arm"])
    parser.add_argument("-i", "--input", help="Your input to assemble or disassemble.", required=True)
    parser.add_argument("-f", "--func", help="Assemble [a] or Disassemble [d].", required=True, choices=["a", "d"])
    parser.add_argument("-v", "--verbose", help="Prints additional data when disassembling bytes", action="store_true")
    args = parser.parse_args()

    if args.func == "d":

        args.input = args.input.replace("0x","")
        args.input = args.input.replace("\\", "")
        args.input = args.input.replace("x", "")
        args.input = args.input.replace(",", "")
        args.input = args.input.replace(";", "")
        args.input = args.input.replace("+", "")
        args.input = args.input.replace(":", "")
        args.input = args.input.replace(" ", "")

        disassemble(args)

    if args.func == "a":
        assemble(args)

if __name__ == '__main__':
    main()